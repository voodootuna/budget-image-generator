<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Budget 2025 2026 Image Creator</title>

  <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:wght@700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Tom Select CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/css/tom-select.css" rel="stylesheet">
  <!-- Tom Select JS -->
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.4.3/dist/js/tom-select.complete.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  
  <style>
    .gradient-bg {
      background: #f3f4f6;
    }
    
    .gradient-text {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .import-button {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    }
    
    .import-button:hover {
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
    }
    
    .generate-button {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    }
    
    .download-button {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
    }
    
    #canvas {
      max-width: 100%;
      height: auto;
    }

    /* Added for drag and drop highlight */
    .drag-over {
      border-color: #3b82f6;
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
    }

    /* Remove Tom Select's inner border */
    .ts-control {
      border: none !important;
      box-shadow: none !important;
      background: transparent !important;
    }
  </style>
</head>
<body class="min-h-screen gradient-bg p-4 font-['Fira_Sans']">
  <div class="max-w-5xl mx-auto">
    <div class="text-gray-800 text-center py-2 mb-3">
      <h1 class="text-4xl font-extrabold">Budget 2025 2026 Image Creator</h1>
    </div>

    <div class="rounded-3xl overflow-hidden">
      <div class="grid lg:grid-cols-[320px_1fr] gap-4 p-4">
        <div class="bg-white p-5 rounded-2xl shadow-lg border border-gray-200">
          <div id="imageDropZone" class="border-4 border-dotted border-gray-400 rounded-2xl p-5 text-center mb-4 bg-gradient-to-br from-gray-50 to-gray-100 transition-all duration-300 cursor-pointer hover:border-gray-500 hover:shadow-lg hover:-translate-y-1">
              <input type="file" id="imageUpload" accept="image/*" class="hidden" />
              <p class="text-base text-gray-600 font-bold mb-3">Drag & Drop your image here</p>
              <button type="button" onclick="document.getElementById('imageUpload').click()" class="import-button text-white px-4 py-2 rounded-full font-bold transition-all duration-300 hover:-translate-y-1 text-sm">or Click to Select Image</button>
              <div class="mt-3 p-3 bg-gray-100 rounded-xl text-xs text-gray-600 leading-relaxed">
                <span class="text-blue-600 font-bold">Pro Tip:</span> You can also paste images directly! Copy an image (Ctrl+C or Cmd+C) and paste it here (Ctrl+V or Cmd+V).
              </div>
          </div>

          <div class="mb-4">
            <label for="themeSelect" class="block font-bold text-gray-600 mb-1 text-xs">Choose a Theme Image:</label>
            <select id="themeSelect" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-sm">
              <option value="">-- Select a Theme --</option>
              <option value="consommation">Consommation</option>
              <option value="carburant">Carburant</option>
              <option value="energies">Énergies</option>
              <option value="fiscalite">Fiscalité</option>
              <option value="tva">TVA</option>
              <option value="pme">PME</option>
              <option value="agriculture">Agriculture</option>
              <option value="peche">Pêche</option>
              <option value="industrie">Industrie</option>
              <option value="construction">Construction</option>
              <option value="logement">Logement</option>
              <option value="technologies">Technologies</option>
              <option value="innovation">Innovation</option>
              <option value="services_financiers">Services financiers</option>
              <option value="tourisme">Tourisme</option>
              <option value="arts_culture">Arts & Culture</option>
              <option value="environnement">Environnement</option>
              <option value="climat">Climat</option>
              <option value="infrastructures">Infrastructures</option>
              <option value="eau">Eau</option>
              <option value="transports">Transports</option>
              <option value="education">Éducation</option>
              <option value="sante">Santé</option>
              <option value="pension">Pension</option>
              <option value="allocation">Allocation</option>
              <option value="protection_sociale">Protection sociale</option>
              <option value="jeunesse">Jeunesse</option>
              <option value="sports">Sports</option>
              <option value="securite">Sécurité</option>
              <option value="justice">Justice</option>
              <option value="rodrigues">Rodrigues</option>
              <option value="agalega">Agaléga</option>
              <option value="chagos">Chagos</option>
              <option value="diaspora">Diaspora</option>
            </select>
          </div>
          <div class="space-y-4">
            <div>
              <input type="text" id="subtitle" placeholder="Subtitle in caps" maxlength="30" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-sm" />
            </div>

            <div>
              <textarea id="title" rows="3" placeholder="Main title here..." maxlength="150" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 resize-y min-h-[60px] text-sm"></textarea>
            </div>

            <div>
              <select id="placement" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-sm">
                <option value="" disabled>Placement</option>
                <option value="1">Top Left</option>
                <option value="3" selected>Bottom Left</option>
                <option value="5">Top Center</option>
                <option value="6">Bottom Center</option>
              </select>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="block font-bold text-gray-600 mb-1 text-xs">Title Size (px):</label>
                <input type="number" id="titleSize" value="80" min="36" max="120" placeholder="Title size" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-sm" />
              </div>
              <div>
                <label class="block font-bold text-gray-600 mb-1 text-xs">Subtitle Size (px):</label>
                <input type="number" id="subtitleSize" value="38" min="20" max="80" placeholder="Subtitle size" class="w-full px-3 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-300 text-sm" />
              </div>
            </div>

            <div class="flex gap-3 pt-4">
              <button onclick="drawCanvas()" class="generate-button flex-1 text-white px-4 py-3 rounded-xl font-bold transition-all duration-300 hover:-translate-y-1 hover:shadow-lg text-sm">Generate Image</button>
              <button onclick="downloadImage()" class="download-button flex-1 text-white px-4 py-3 rounded-xl font-bold transition-all duration-300 hover:-translate-y-1 hover:shadow-lg text-sm">Download Image</button>
            </div>
          </div>
        </div>

        <div class="flex justify-center items-start">
          <canvas id="canvas" width="1000" height="1250" class="rounded-xl shadow-xl bg-white"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const imageInput = document.getElementById('imageUpload');
    const titleInput = document.getElementById('title');
    const subtitleInput = document.getElementById('subtitle');
    const placementInput = document.getElementById('placement');
    const titleSizeInput = document.getElementById('titleSize');
    const subtitleSizeInput = document.getElementById('subtitleSize');
    const themeSelect = document.getElementById('themeSelect');
    let subtitleManuallyEdited = false;  // Add flag to track subtitle edits

    let uploadedImage = null;

    // Main Logo (bottom center)
    const logo = new Image();
    logo.src = 'assets/logo.png';
    let logoLoaded = false;
    logo.onload = () => {
      logoLoaded = true;
      drawCanvas();
    };
    logo.onerror = () => {
      console.warn("Main logo (logo.png) failed to load. Please check its path in the 'assets' folder.");
      logoLoaded = false;
      drawCanvas();
    };

    // Existing Top-Right Logo
    const logo2 = new Image();
    logo2.src = 'assets/Asset 2@1.png';
    let logo2Loaded = false;
    logo2.onload = () => {
      logo2Loaded = true;
      drawCanvas();
    };
    logo2.onerror = () => {
      console.warn("Top-right logo (Asset 2@1.png) failed to load. Please check its path in the 'assets' folder.");
      logo2Loaded = false;
      drawCanvas();
    };

    // Third Logo (Top-Left)
    const logo3 = new Image();
    logo3.src = 'assets/budget202526.png';
    let logo3Loaded = false;
    logo3.onload = () => {
      logo3Loaded = true;
      drawCanvas();
    };
    logo3.onerror = () => {
      console.warn("Third logo (budget202526.png) failed to load. Please check its path in the 'assets' folder.");
      logo3Loaded = false;
      drawCanvas();
    };

    // Function to load a predefined theme image
    function loadThemeImage(themeName) {
      if (!themeName) {
        uploadedImage = null;
        drawCanvas();
        return;
      }
      const img = new Image();
      img.src = `assets/themes/${themeName}.jpg`;
      img.onload = () => {
        uploadedImage = img;
        drawCanvas();
      };
      img.onerror = () => {
        alert(`Could not load theme image: ${themeName}. Please ensure the file exists in 'assets/themes/' and the correct extension (.jpg/.png) is used.`);
        uploadedImage = null;
        drawCanvas();
      };
    }

    // Add event listener for the theme select dropdown
    themeSelect.addEventListener('change', (e) => {
      const selectedTheme = e.target.value;
      if (selectedTheme) {
        loadThemeImage(selectedTheme);
        // Set subtitle automatically if it hasn't been manually edited
        if (!subtitleManuallyEdited) {
          subtitleInput.value = selectedTheme.charAt(0).toUpperCase() + selectedTheme.slice(1).replace(/_/g, ' ');
          drawCanvas();
        }
        imageInput.value = '';
        imageDropZone.classList.remove('drag-over');
      } else {
        uploadedImage = null;
        drawCanvas();
      }
    });

    // Add event listener for subtitle input to track manual edits
    subtitleInput.addEventListener('input', () => {
      subtitleManuallyEdited = true;
      drawCanvas();
    });

    // Add event listener for subtitle focus to track manual edits
    subtitleInput.addEventListener('focus', () => {
      subtitleManuallyEdited = true;
    });

    // Reset subtitle edit flag when subtitle is cleared
    subtitleInput.addEventListener('change', () => {
      if (!subtitleInput.value.trim()) {
        subtitleManuallyEdited = false;
      }
    });

    // Paste functionality
    function handlePaste(e) {
      const items = e.clipboardData?.items;
      if (!items) return;

      for (let item of items) {
        if (item.type.startsWith('image/')) {
          e.preventDefault();
          const file = item.getAsFile();
          if (file) {
            loadImageFromFile(file);
            themeSelect.value = '';
          }
          break;
        }
      }
    }

    function loadImageFromFile(file) {
      if (!file.type.startsWith('image/')) {
        alert("Please upload an image file (e.g., JPEG, PNG, GIF).");
        return;
      }

      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          uploadedImage = img;
          drawCanvas();
        };
        img.onerror = () => {
          alert("Could not load image. Please try another file.");
          uploadedImage = null;
          drawCanvas();
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    }

    // Add paste event listeners
    document.addEventListener('paste', handlePaste);
    document.getElementById('imageDropZone').addEventListener('paste', handlePaste);

    // Make the drop zone focusable for paste events
    document.getElementById('imageDropZone').setAttribute('tabindex', '0');

    // Drag and Drop Logic
    const imageDropZone = document.getElementById('imageDropZone');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      imageDropZone.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults (e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      imageDropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      imageDropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
      imageDropZone.classList.add('drag-over');
    }

    function unhighlight() {
      imageDropZone.classList.remove('drag-over');
    }

    imageDropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;

      if (files.length > 0) {
        loadImageFromFile(files[0]);
        themeSelect.value = '';
      }
    }

    imageInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) {
        uploadedImage = null;
        drawCanvas();
        return;
      }
      loadImageFromFile(file);
      themeSelect.value = '';
    });

    [titleInput, subtitleInput, placementInput, titleSizeInput, subtitleSizeInput].forEach(el => {
      el.addEventListener('input', drawCanvas);
    });

    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (uploadedImage) {
        const imgRatio = uploadedImage.width / uploadedImage.height;
        const canvasRatio = canvas.width / canvas.height;

        ctx.save();
        ctx.filter = 'blur(30px)';
        if (imgRatio < canvasRatio) {
          const h = canvas.width / imgRatio;
          ctx.drawImage(uploadedImage, 0, (canvas.height - h) / 2, canvas.width, h);
        } else {
          const w = canvas.height * imgRatio;
          ctx.drawImage(uploadedImage, (canvas.width - w) / 2, 0, w, canvas.height);
        }
        ctx.restore();

        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        let imgW = canvas.width, imgH = canvas.height;
        if (imgRatio < canvasRatio) {
          imgH = canvas.height;
          imgW = imgH * imgRatio;
        } else {
          imgW = canvas.width;
          imgH = imgW / imgRatio;
        }
        ctx.drawImage(
          uploadedImage,
          (canvas.width - imgW) / 2,
          (canvas.height - imgH) / 2,
          imgW,
          imgH
        );
      } else {
        ctx.fillStyle = '#ccc';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#444';
        ctx.font = "700 36px 'Fira Sans', sans-serif";
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText("Drag & Drop, Click to Upload, Paste, or Select a Theme Image", canvas.width / 2, canvas.height / 2);
        ctx.textAlign = 'left';
        ctx.textBaseline = 'top';
        return;
      }

      const logoWidth = 400;
      const logoHeight = logoLoaded ? logo.height * (logoWidth / logo.width) : 100;
      const logoX = (canvas.width - logoWidth) / 2;
      const logoY = canvas.height - logoHeight - 30;

      const titleRaw = titleInput.value.trim();
      const subtitle = subtitleInput.value.trim().toUpperCase();
      const placement = parseInt(placementInput.value);
      let titleSize = parseInt(titleSizeInput.value);
      const subtitleSizeAdj = parseInt(subtitleSizeInput.value);
      const spacingBetween = 12;
      const maxTextWidth = canvas.width - 200;

      let lines = [];
      function wrapLines() {
        lines = [];
        let line = '';
        ctx.font = `800 ${titleSize}px 'Fira Sans', sans-serif`;
        const words = titleRaw.split(' ');
        for (let word of words) {
          const test = line + word + ' ';
          if (ctx.measureText(test).width > maxTextWidth && line !== '') {
            lines.push(line.trim());
            line = word + ' ';
          } else {
            line = test;
          }
        }
        if (line) lines.push(line.trim());
        return lines.length;
      }

      while (wrapLines() > 3 && titleSize > 36) {
        titleSize -= 2;
      }

      const updatedLineHeight = titleSize * 1.05;
      const titleBlockHeight = subtitleSizeAdj + spacingBetween + lines.length * updatedLineHeight;

      const TOP_MARGIN = 240;
      const BOTTOM_MARGIN = 160;
      const placementMap = {
        1: { x: 100, align: 'left', y: TOP_MARGIN },   // Top Left
        3: { x: 100, align: 'left', y: 0 },     // Bottom Left (y calculated dynamically)
        5: { x: canvas.width / 2, align: 'center', y: TOP_MARGIN }, // Top Center
        6: { x: canvas.width / 2, align: 'center', y: 0 }     // Bottom Center (y calculated dynamically)
      };

      let posX = placementMap?.[placement]?.x ?? 100;
      let align = placementMap?.[placement]?.align ?? 'left';
      let posY = placementMap?.[placement]?.y ?? TOP_MARGIN;

      if (placement === 3 || placement === 6) {
        posY = logoY - BOTTOM_MARGIN - titleBlockHeight;
      }

      if (uploadedImage && (titleRaw || subtitle)) {
        const gradientPadding = 150;
        let gradient;
        
        if (placement === 1 || placement === 5) {
          const gradientEndY = posY + titleBlockHeight + gradientPadding;
          gradient = ctx.createLinearGradient(0, 0, 0, gradientEndY);
          gradient.addColorStop(0, 'rgba(0,0,0,0.8)');
          gradient.addColorStop(0.6, 'rgba(0,0,0,0.4)');
          gradient.addColorStop(1, 'rgba(0,0,0,0)');
          
          ctx.fillStyle = gradient;
          ctx.fillRect(0, 0, canvas.width, gradientEndY);
        } else if (placement === 3 || placement === 6) {
          const gradientStartY = posY - gradientPadding;
          gradient = ctx.createLinearGradient(0, gradientStartY, 0, canvas.height);
          gradient.addColorStop(0, 'rgba(0,0,0,0)');
          gradient.addColorStop(0.4, 'rgba(0,0,0,0.4)');
          gradient.addColorStop(1, 'rgba(0,0,0,0.8)');
          
          ctx.fillStyle = gradient;
          ctx.fillRect(0, gradientStartY, canvas.width, canvas.height - gradientStartY);
        }
      }

      // --- 6. Draw Text ---
      ctx.textAlign = align;
      ctx.textBaseline = 'top';

      // Draw subtitle with red background (no shadow, no rounded corners, visually balanced padding)
      ctx.font = `700 ${subtitleSizeAdj}px 'Fira Sans', sans-serif`;
      const subtitleText = subtitle;
      const subtitleMetrics = ctx.measureText(subtitleText);
      const paddingX = 16;
      const paddingTop = 16;
      const paddingBottom = 10;
      const rectWidth = subtitleMetrics.width + paddingX * 2;
      const rectHeight = subtitleSizeAdj + paddingTop + paddingBottom;
      let subtitleRectX, subtitleRectY, subtitleTextX, subtitleTextY;

      if (align === 'center') {
        subtitleRectX = posX - rectWidth / 2;
        subtitleTextX = posX;
      } else {
        subtitleRectX = posX;
        subtitleTextX = posX + paddingX;
      }
      subtitleRectY = posY;
      subtitleTextY = posY + paddingTop;

      // Remove shadow for subtitle
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;

      // Draw red rectangle
      ctx.save();
      ctx.fillStyle = '#ef4444'; // Tailwind red-500
      ctx.fillRect(subtitleRectX, subtitleRectY, rectWidth, rectHeight);
      ctx.restore();

      // Draw subtitle text (no shadow)
      ctx.fillStyle = 'white';
      ctx.textAlign = align;
      ctx.textBaseline = 'top';
      if (align === 'center') {
        ctx.fillText(subtitleText, subtitleTextX, subtitleTextY);
      } else {
        ctx.fillText(subtitleText, subtitleTextX, subtitleTextY);
      }

      // Restore shadow for title
      ctx.shadowColor = 'rgba(0,0,0,0.4)';
      ctx.shadowBlur = 4;
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;

      // Draw title below the subtitle rectangle
      ctx.font = `800 ${titleSize}px 'Fira Sans', sans-serif`;
      for (let i = 0; i < lines.length; i++) {
        ctx.fillText(
          lines?.[i] ?? '',
          posX,
          subtitleRectY + rectHeight + spacingBetween + i * updatedLineHeight
        );
      }

      const logo2DesiredWidth = 100;
      let logo2Height = 0;
      if (logo2Loaded) {
          logo2Height = logo2.height * (logo2DesiredWidth / logo2.width);
          const logo2X = canvas.width - logo2DesiredWidth - 50;
          const logo2Y = 50;
          ctx.drawImage(logo2, logo2X, logo2Y, logo2DesiredWidth, logo2Height);
      }
      
      const logo3DesiredWidth = 835;
      let logo3Height = 0;
      if (logo3Loaded) {
          logo3Height = logo3.height * (logo3DesiredWidth / logo3.width);
          const logo3X = 0;
          const logo3Y = 50;
          ctx.drawImage(logo3, logo3X, logo3Y, logo3DesiredWidth, logo3Height);
      }

      if (logoLoaded) {
          ctx.drawImage(logo, logoX, logoY, logoWidth, logoHeight);
      }
    }

    function downloadImage() {
      const buttonContainer = document.querySelector('.flex.gap-3.pt-4');
      const downloadButton = buttonContainer.querySelector('button:last-child');
      const generateButton = buttonContainer.querySelector('button:first-child');
      const importButton = document.querySelector('.import-button');

      const originalDownloadText = downloadButton.textContent;
      downloadButton.textContent = 'Downloading...';
      downloadButton.disabled = true;
      generateButton.disabled = true;
      importButton.disabled = true;

      try {
        const link = document.createElement('a');
        link.download = 'social-media-image.png';
        link.href = canvas.toDataURL('image/png');
        link.click();

        setTimeout(() => {
          downloadButton.textContent = originalDownloadText;
          downloadButton.disabled = false;
          generateButton.disabled = false;
          importButton.disabled = false;
        }, 2000);
      } catch (error) {
        console.error("Download failed:", error);
        alert("Image download failed. Please try again.");
        downloadButton.textContent = originalDownloadText;
        downloadButton.disabled = false;
        generateButton.disabled = false;
        importButton.disabled = false;
      }
    }

    // Initialize Tom Select for themeSelect
    document.addEventListener('DOMContentLoaded', function() {
      new TomSelect('#themeSelect', {
        allowEmptyOption: true,
        create: false,
        placeholder: '-- Select a Theme --'
      });
    });

    window.onload = drawCanvas;
  </script>
</body>
</html> 